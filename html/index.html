<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<head>
   <title>OpenStreetMap Analytic Difference Engine</title>
   <link rel="icon" href="/osm/favicon.png" type="image/png">
   <link href="/osm/styles.css" type="text/css" rel="stylesheet"/>
   <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
   <script src="/jquery-2.1.3/jquery.min.js"></script>
   <link rel="stylesheet" href="/leaflet-0.7.3/leaflet.css" />
   <script src="/leaflet-0.7.3/leaflet.js"></script>
   <script src="/osm/timestamp.js"></script>
</head>
<nav>
<ul>
<li><a href="https://github.com/MichaelVL/osm-analytic-tracker/"><img src="/osm/icon_bw.png"></a></li>
<li><a href="/osm/index.html">Live Changesets</a></li>
<li><a href="/osm/cset_notes.html">Changeset Notes</a></li>
<li><a href="/osm/addresses.html">Address Changes</a></li>
<!-- <li><a href="/osm/addresses.html">New feature<img src=att_l.png> NEW</a></li> -->
</ul>
</nav>
<body>
<div id="gen" style="display:none">-</div>
<div id="gen_loaded" style="display:none">-</div>
<div style="display:inline-block">
 <div id="map"></div>
 <div id="summary">Loading...</div>
</div>
<div id="csetlist">
  <div id="logger">Loading...</div><br>
</div>
<script type="text/javascript">
var refresh = 60000;
var age = 0;

(function($)
{
  $(document).ready(function()
  {
    $.ajaxSetup( { cache: false });
    refresh = location.search.split('refresh=')[1];
    if (refresh===undefined || refresh<30000) { refresh = 60000; }
    small_load();
  });
})(jQuery);

var refresher;
function set_refresher(refresh) {
  clearInterval(refresher);
  if (refresh > 0) {
    console.log('Refresh interval='+refresh);
    refresher = setInterval(small_load, refresh);
  }
}

function small_load() {
  console.log('small_load()');
  $("#summary").load("/osmt/today-summ.html", small_load_done);
}

function small_load_done(respTxt, txtStatus, req) {
  console.log('small_load_done():'+txtStatus);
  large_load_test();  
}

function large_load_test() {
  console.log('large_load_test()');
  $("#gen").text($("#generation").text());
  compute_lag();
  if ($("#gen").text() != $("#gen_loaded").text()) {
    console.log('Not in sync, have '+$("#gen").text()+' and '+$("#gen_loaded").text());
    age = 0;
    $("#gen_loaded").text($("#gen").text());
    $("#logger").load("/osmt/today.html", large_load_done);
    load_json();
    set_refresher(refresh);
  } else {
    age += Math.round(refresh/1000);
    tstype();
    console.log('In sync, have '+$("#gen").text()+' and '+$("#gen_loaded").text()+' age '+age);
    if (age > 5*60) {
      set_refresher(5*refresh); // Backoff
    }
  }
}

function large_load_done() {
  console.log('large_load_done()');
    $(".legend").after("<div class=\"hts\"></div>");
    $(".new").slideDown(1000);
    tstype();
}

function compute_lag(ts_src, dest) {
  //var ts = $("#summary_created").text();
  var ts = $("#pointer_timestamp").text();
  var hts = htimestamp(ts, undefined, undefined);
  $("#lag").text("Lag: "+hts);
}

function tstype() {
  $("li.cset").each(function(index) {
    var ts = $(this).data("timestamp");
    var hts = htimestamp(ts, "Now", "ago");
    //console.log(index+" timetamp "+ts+" htimetamp "+hts);
    $(this).find(".hts").text(hts);
  });
}

var tileUrl = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'
var tileUrlBw = 'http://{s}.tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png'
var osmAttrib='&copy <a href="http://openstreetmap.org">OpenStreetMap</a> contributors';

var map = new L.Map('map', {'dragging' : true, 'zoomControl': false, 'doubleClickZoom': false,}).setView(new L.LatLng(56.0, 11.4),6);
//var osm = new L.TileLayer(tileUrlBw,
//  {minZoom: 6, maxZoom: 18, subdomains: ['a','b','c'], attribution: osmAttrib});
var osm = new L.TileLayer(tileUrl,
  {minZoom: 6, maxZoom: 18, subdomains: ['a','b','c'], attribution: osmAttrib, opacity:0.4});
map.addLayer(osm);
map.attributionControl.setPrefix(''); // Dont show 'powered by..'

//var info = L.control();

//info.onAdd = function (map) {
//  this._div = L.DomUtil.create('div', 'mapinfo');
//  this.update();
//  return this._div;
//};
//info.update = function (props) {
//    if (props) {
//        this._div.innerHTML = '<h4>Changeset ' + props.id + '</h4>'
//            + '<span class="mapinfo-comment">' + props.comment + '</span><br />'
//            + 'by <span class="mapinfo-user">' + props.user + '</span>';
//    } else {
//        this._div.innerHTML = '<h4>Changeset Information</h4>' + 'Hover over BBox';
//    }
//};
//info.addTo(map);

var markers = new L.geoJson().addTo(map);
//load_json();

function styleFunc(feature) {
  return {
    weight: 3,
    opacity: 1,
    color: feature.properties.color,
    fillOpacity: 0.2
  };
}

function highlightFeature(e) {
  var layer = e.target;
  //var popbody = 'Comment: <span class="mapinfo-comment">'+layer.feature.properties.comment+'</span><br />User: <span class="mapinfo-user">'+layer.feature.properties.user+'</span>';
  var popbody = '<table><tbody>';
  h = layer.feature.properties.meta;
  console.log('h='+h);
  tag = layer.feature.properties.meta['tag'];
  console.log('tag='+tag);
  for (var k in h) {
      if (k!= 'tag' && k!='min_lat' && k!='max_lat' && k!='min_lon' && k!='max_lon' && k!='uid' && k!='discussion' && h.hasOwnProperty(k)) {
      popbody += '<tr><td>' + k + '</td><td>' + h[k] + '</td></tr>';
    }
  }
  for (var k in tag) {
      if (k!='locale' && tag.hasOwnProperty(k)) {
      popbody += '<tr><td>' + k + '</td><td>' + tag[k] + '</td></tr>';
    }
  }
  popbody += '</tbody></table>';
      
  layer.bindPopup(popbody).openPopup();  
  layer.setStyle({
    weight: 4,
    color: '#404040',
    dashArray: '',
    fillOpacity: 0.7
  });
  if (!L.Browser.ie && !L.Browser.opera) {
    layer.bringToFront();
  }
  //info.update(layer.feature.properties);
}

function resetHighlight(e) {
  markers.resetStyle(e.target);
  //info.update();
}

function zoomToFeature(e) {
  map.fitBounds(e.target.getBounds());
}
function gotoVisualDiffFeature(e) {
  window.open(e.target.feature.properties.visualdiff);
  //window.open(e.target.feature.properties.url);
}

function onEachFeature(feature, layer) {
  layer.on({
    mouseover: highlightFeature,
    mouseout: resetHighlight,
    click: gotoVisualDiffFeature
    //click: zoomToFeature
  });
}

function load_json(){
  $.ajax({
    datatype: "json",
    url: "/osmt/today.json",
    success: function(data, text) {
      map.removeLayer(markers);
      markers = new L.geoJson(data, { style: styleFunc, onEachFeature: onEachFeature }).addTo(map);
    }
  }).error(function(jqXHR, textStatus, errorThrown) { console.log("json_load() error:"+textStatus); });
}
</script>
</body>
